# =============================================================================
# File Schema
# =============================================================================
# This schema defines how to write exfs file specifications.
#
# Namespaces:
#   exfs.*           - File traversal (captures, engines)
#   core.*           - System-provided (terminals, transpiler)
#
# Sync directionality:
#   with: exfs.*     - Bidirectional (core.transpiler only)
#   to:   exfs.*     - This capture pushes to peer
#   from: exfs.*     - This capture pulls from peer
# =============================================================================

$schema: "https://json-schema.org/draft/2020-12/schema"
$id: "https://exfs.org/schemas/file"
title: "EXFS File Schema"
description: "Defines how to write an exfs file definition"

# -----------------------------------------------------------------------------
# Root Structure
# -----------------------------------------------------------------------------
# A file is an object where:
#   - Keys are names of your choice
#   - Values are captures defining what code to match
# -----------------------------------------------------------------------------

type: object

additionalProperties:
  $ref: "#/$defs/capture"

# -----------------------------------------------------------------------------
# Definitions
# -----------------------------------------------------------------------------

$defs:
  # ---------------------------------------------------------------------------
  # Capture
  # ---------------------------------------------------------------------------
  # A capture rule that defines what code productions to match.
  #
  # Required:
  #   type     - The terminal to match (core.<lang>.<terminal>)
  #
  # Optional:
  #   limit    - Limit number of items (int or {min, max})
  #   contains - Nested captures (captures can contain captures)
  #   sync     - Peer relationships for cross-view synchronization
  # ---------------------------------------------------------------------------
  capture:
    type: object

    properties:
      type:
        $ref: "#/$defs/terminal"

      limit:
        $ref: "#/$defs/limit"

      contains:
        type: object
        additionalProperties:
          $ref: "#/$defs/capture"
        description: "Nested captures within this capture"

      sync:
        $ref: "#/$defs/sync"

    required:
      - type

  # ---------------------------------------------------------------------------
  # Terminal
  # ---------------------------------------------------------------------------
  # A grammar terminal to capture.
  # Must be: core.<lang>.<terminal>
  #
  # See languages/productions/*.yml for available terminals per language.
  # Cross-view operations are handled via the sync property, not type.
  # ---------------------------------------------------------------------------
  terminal:
    oneOf:
      # Core languages (productions/)
      - $ref: "./languages/productions/go.yml#/$defs/terminals"
      - $ref: "./languages/productions/py.yml#/$defs/terminals"
      - $ref: "./languages/productions/js.yml#/$defs/terminals"
      - $ref: "./languages/productions/ts.yml#/$defs/terminals"
      - $ref: "./languages/productions/html.yml#/$defs/terminals"
      - $ref: "./languages/productions/css.yml#/$defs/terminals"
      - $ref: "./languages/productions/swift.yml#/$defs/terminals"
      - $ref: "./languages/productions/c.yml#/$defs/terminals"
      - $ref: "./languages/productions/cpp.yml#/$defs/terminals"
      - $ref: "./languages/productions/rs.yml#/$defs/terminals"
      - $ref: "./languages/productions/java.yml#/$defs/terminals"
      - $ref: "./languages/productions/rb.yml#/$defs/terminals"
      - $ref: "./languages/productions/sh.yml#/$defs/terminals"

      # Data formats (productions/)
      - $ref: "./languages/productions/json.yml#/$defs/terminals"
      - $ref: "./languages/productions/yaml.yml#/$defs/terminals"
      - $ref: "./languages/productions/toml.yml#/$defs/terminals"
      - $ref: "./languages/productions/md.yml#/$defs/terminals"

      # Composed frameworks (compositions/)
      - $ref: "./languages/compositions/svelte.yml#/$defs/terminals"
      - $ref: "./languages/compositions/astro.yml#/$defs/terminals"

  # ---------------------------------------------------------------------------
  # Limit
  # ---------------------------------------------------------------------------
  # Limits how many items to capture. Can be:
  #   - integer: exact max
  #   - object: range with min and/or max
  #
  # Omit limit for unlimited.
  # ---------------------------------------------------------------------------
  limit:
    oneOf:
      - type: integer
        minimum: 1
        description: "Maximum number of items"

      - type: object
        properties:
          min:
            type: integer
            minimum: 0
            description: "Minimum number of items"
          max:
            type: integer
            minimum: 1
            description: "Maximum number of items"
        additionalProperties: false

  # ---------------------------------------------------------------------------
  # Sync
  # ---------------------------------------------------------------------------
  # Peer relationships for cross-view synchronization.
  # ---------------------------------------------------------------------------
  sync:
    type: array
    items:
      $ref: "#/$defs/sync_entry"
    minItems: 1

  # ---------------------------------------------------------------------------
  # Sync Entry
  # ---------------------------------------------------------------------------
  # Defines relationship with a single peer capture.
  #
  # Use exactly ONE of:
  #   with - Bidirectional sync (core.transpiler only)
  #   to   - This capture pushes to peer (unidirectional)
  #   from - This capture pulls from peer (unidirectional)
  #
  # Optional:
  #   engine - Transform engine (default: core.transpiler)
  #            Custom engines (exfs.*) require 'to' or 'from', not 'with'
  # ---------------------------------------------------------------------------
  sync_entry:
    type: object
    properties:
      with:
        type: string
        pattern: "^exfs\\."
        description: |
          Bidirectional peer capture.
          Uses core.transpiler. Cannot use custom engine.

      to:
        type: string
        pattern: "^exfs\\."
        description: |
          Peer capture to push to.
          This capture → peer (unidirectional).

      from:
        type: string
        pattern: "^exfs\\."
        description: |
          Peer capture to pull from.
          Peer → this capture (unidirectional).

      engine:
        type: string
        pattern: "^(core\\.transpiler|exfs\\.)"
        description: |
          Transform engine reference.
          - core.transpiler: Built-in bidirectional (default)
          - exfs.<path>: Custom engine yaml

    additionalProperties: false

    # -------------------------------------------------------------------------
    # Validation: Exactly one of with/to/from required
    # -------------------------------------------------------------------------
    oneOf:
      # Option 1: Bidirectional with 'with'
      - required: [with]
        not:
          anyOf:
            - required: [to]
            - required: [from]
        # 'with' cannot use custom engine
        if:
          required: [engine]
        then:
          properties:
            engine:
              const: core.transpiler

      # Option 2: Unidirectional with 'to'
      - required: [to]
        not:
          anyOf:
            - required: [with]
            - required: [from]

      # Option 3: Unidirectional with 'from'
      - required: [from]
        not:
          anyOf:
            - required: [with]
            - required: [to]

# =============================================================================
# File Schema
# =============================================================================
# This schema defines how to write exfs file specifications
# =============================================================================

$schema: "https://json-schema.org/draft/2020-12/schema"
$id: "https://exfs.org/schemas/file"
title: "EXFS File Schema"
description: "Defines how to write an exfs file definition"

# -----------------------------------------------------------------------------
# Root Structure
# -----------------------------------------------------------------------------
# A file is an object where:
#   - Keys are names of your choice
#   - Values are captures defining what code to match
# -----------------------------------------------------------------------------

type: object

additionalProperties:
  $ref: "#/$defs/capture"

# -----------------------------------------------------------------------------
# Definitions
# -----------------------------------------------------------------------------

$defs:
  # ---------------------------------------------------------------------------
  # Capture
  # ---------------------------------------------------------------------------
  # A capture rule that defines what code productions to match.
  #
  # Required:
  #   type    - The terminal to match
  #
  # Optional:
  #   limit    - Limit number of items (int or {min, max})
  #   contains - Nested captures (captures can contain captures)
  # ---------------------------------------------------------------------------
  capture:
    type: object

    properties:
      type:
        $ref: "#/$defs/terminal"

      limit:
        $ref: "#/$defs/limit"

      contains:
        type: object
        additionalProperties:
          $ref: "#/$defs/capture"
        description: "Nested captures within this capture"

    required:
      - type

  # ---------------------------------------------------------------------------
  # Terminal
  # ---------------------------------------------------------------------------
  # A grammar terminal to capture.
  # Must be one of the defined terminals from a language productions file.
  #
  # See languages/productions/*.yml for available terminals per language.
  # ---------------------------------------------------------------------------
  terminal:
    oneOf:
      # Core languages (productions/)
      - $ref: "./languages/productions/go.yml#/$defs/terminals"
      - $ref: "./languages/productions/python.yml#/$defs/terminals"
      - $ref: "./languages/productions/js.yml#/$defs/terminals"
      - $ref: "./languages/productions/ts.yml#/$defs/terminals"
      - $ref: "./languages/productions/html.yml#/$defs/terminals"
      - $ref: "./languages/productions/css.yml#/$defs/terminals"
      - $ref: "./languages/productions/swift.yml#/$defs/terminals"
      - $ref: "./languages/productions/c.yml#/$defs/terminals"
      - $ref: "./languages/productions/cpp.yml#/$defs/terminals"
      - $ref: "./languages/productions/rust.yml#/$defs/terminals"
      - $ref: "./languages/productions/java.yml#/$defs/terminals"
      - $ref: "./languages/productions/ruby.yml#/$defs/terminals"
      - $ref: "./languages/productions/bash.yml#/$defs/terminals"

      # Data formats (productions/)
      - $ref: "./languages/productions/json.yml#/$defs/terminals"
      - $ref: "./languages/productions/yaml.yml#/$defs/terminals"
      - $ref: "./languages/productions/toml.yml#/$defs/terminals"
      - $ref: "./languages/productions/markdown.yml#/$defs/terminals"

      # Composed frameworks (compositions/)
      - $ref: "./languages/compositions/svelte.yml#/$defs/terminals"
      - $ref: "./languages/compositions/astro.yml#/$defs/terminals"

  # ---------------------------------------------------------------------------
  # Limit
  # ---------------------------------------------------------------------------
  # Limits how many items to capture. Can be:
  #   - integer: exact max
  #   - object: range with min and/or max
  #
  # Omit limit for unlimited.
  # ---------------------------------------------------------------------------
  limit:
    oneOf:
      - type: integer
        minimum: 1
        description: "Maximum number of items"

      - type: object
        properties:
          min:
            type: integer
            minimum: 0
            description: "Minimum number of items"
          max:
            type: integer
            minimum: 1
            description: "Maximum number of items"
        additionalProperties: false
